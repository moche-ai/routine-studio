import json
import sys
import os
import re
from typing import Dict, Any, List, Optional
from dataclasses import dataclass, field
from enum import Enum
from pathlib import Path

sys.path.append('/data/routine/routine-studio-v2')

from agents.base import AgentResult, AgentStatus
from agents.planner.agent import PlannerAgent
from agents.character.agent import CharacterAgent
from agents.benchmarker.agent import BenchmarkerAgent
from apps.api.services.vision import vision_service
from agents.image_utils import optimize_image

SESSIONS_DIR = Path('/data/routine/routine-studio-v2/output/.sessions')
SESSIONS_DIR.mkdir(parents=True, exist_ok=True)

class WorkflowStep(Enum):
    CHANNEL_NAME = 'channel_name'
    BENCHMARKING = 'benchmarking'
    CHARACTER = 'character'
    VIDEO_IDEAS = 'video_ideas'
    SCRIPT = 'script'
    COMPLETED = 'completed'

@dataclass
class Session:
    id: str
    current_step: WorkflowStep = WorkflowStep.CHANNEL_NAME
    context: Dict[str, Any] = field(default_factory=dict)
    history: List[Dict[str, Any]] = field(default_factory=list)

    def to_dict(self) -> Dict:
        return {
            'id': self.id,
            'current_step': self.current_step.value,
            'context': self.context,
            'history': self.history
        }

    @classmethod
    def from_dict(cls, data: Dict) -> 'Session':
        return cls(
            id=data['id'],
            current_step=WorkflowStep(data['current_step']),
            context=data.get('context', {}),
            history=data.get('history', [])
        )

def save_session(session: Session):
    path = SESSIONS_DIR / f'{session.id}.json'
    with open(path, 'w') as f:
        json.dump(session.to_dict(), f, ensure_ascii=False, indent=2)

def load_session(session_id: str) -> Optional[Session]:
    path = SESSIONS_DIR / f'{session_id}.json'
    if path.exists():
        with open(path) as f:
            return Session.from_dict(json.load(f))
    return None

class Orchestrator:
    STEP_ORDER = [
        WorkflowStep.CHANNEL_NAME,
        WorkflowStep.BENCHMARKING,
        WorkflowStep.CHARACTER,
        WorkflowStep.VIDEO_IDEAS,
        WorkflowStep.SCRIPT,
        WorkflowStep.COMPLETED
    ]

    def __init__(self):
        self.sessions: Dict[str, Session] = {}
        self.planner = PlannerAgent()
        self.character_agent = CharacterAgent()
        self.benchmarker_agents: Dict[str, BenchmarkerAgent] = {}

    def get_or_create_session(self, session_id: str) -> Session:
        if session_id in self.sessions:
            return self.sessions[session_id]

        session = load_session(session_id)
        if session:
            self.sessions[session_id] = session
            for key in ['channel_names', 'selected_channel_name', 'video_ideas', 'selected_video_idea', 'benchmark_report']:
                if key in session.context:
                    self.planner.set_context(key, session.context[key])
            return session

        session = Session(id=session_id)
        self.sessions[session_id] = session
        return session

    def _save(self, session: Session):
        save_session(session)

    def _get_current_agent(self, step: WorkflowStep, session_id: str = None):
        if step == WorkflowStep.CHARACTER:
            return self.character_agent
        elif step == WorkflowStep.BENCHMARKING:
            if session_id and session_id not in self.benchmarker_agents:
                self.benchmarker_agents[session_id] = BenchmarkerAgent()
            return self.benchmarker_agents.get(session_id, BenchmarkerAgent())
        return self.planner

    def _extract_number(self, message: str) -> Optional[int]:
        if message.strip().isdigit():
            return int(message.strip())

        match = re.search(r'(\d+)\s*ë²ˆ', message)
        if match:
            return int(match.group(1))

        korean_nums = {'ì²«': 1, 'ë‘': 2, 'ì„¸': 3, 'ë„¤': 4, 'ë‹¤ì„¯': 5,
                       'ì—¬ì„¯': 6, 'ì¼ê³±': 7, 'ì—¬ëŸ': 8, 'ì•„í™‰': 9, 'ì—´': 10}
        for k, v in korean_nums.items():
            if k in message:
                return v

        return None

    def _is_confirmation(self, message: str) -> bool:
        confirmations = ['í™•ì •', 'ì¢‹ì•„', 'ì´ê±¸ë¡œ', 'ë‹¤ìŒ', 'ok', 'OK', 'ì™„ë£Œ', 'í• ê»˜', 'í• ê²Œ']
        return any(c in message for c in confirmations)

    def _is_selection(self, message: str) -> bool:
        return self._extract_number(message) is not None

    def _format_character_intro(self, char_info: dict) -> str:
        '''ìºë¦­í„° ë¶„ì„ ê²°ê³¼ë¥¼ í•œêµ­ì–´ ì†Œê°œ ë¬¸ì¥ìœ¼ë¡œ ë³€í™˜'''
        if not char_info:
            return ''
        
        parts = []
        
        # ìºë¦­í„° íƒ€ì…
        char_type = char_info.get('character_type', '')
        if char_type == 'human':
            parts.append('ì‚¬ëŒ ìºë¦­í„°')
        elif char_type == 'animal':
            parts.append('ë™ë¬¼ ìºë¦­í„°')
        elif char_type:
            parts.append(f'{char_type} ìºë¦­í„°')
        
        # ì„±ë³„
        gender = char_info.get('gender', '')
        if gender == 'male':
            parts.append('ë‚¨ì„±')
        elif gender == 'female':
            parts.append('ì—¬ì„±')
        
        # ì˜·ì°¨ë¦¼
        clothing = char_info.get('clothing', '')
        if clothing and clothing != 'clothing description':
            parts.append(f'{clothing} ì°©ìš©')
        
        # í‘œì •
        expression = char_info.get('expression', '')
        if expression and expression != 'expression description':
            parts.append(f'{expression} í‘œì •')
        
        # ì•„íŠ¸ ìŠ¤íƒ€ì¼
        art_style = char_info.get('art_style', '')
        if art_style and art_style != 'art style description':
            parts.append(f'{art_style} ìŠ¤íƒ€ì¼')
        
        if parts:
            return '[ìºë¦­í„° ë¶„ì„] ' + ', '.join(parts)
        return ''

    async def start(self, session_id: str, input_data: Dict[str, Any]) -> Dict[str, Any]:
        session = self.get_or_create_session(session_id)
        session.context['user_request'] = input_data.get('user_request', '')

        result = await self.planner.execute({
            'step': 'channel_name',
            'user_request': input_data.get('user_request', '')
        })

        if result.data and 'channel_names' in result.data:
            session.context['channel_names'] = result.data['channel_names']

        self._save(session)
        return self._format_response(session, result)

    async def process_message(self, session_id: str, message: str, images: List[str] = None) -> Dict[str, Any]:
        session = self.get_or_create_session(session_id)
        current_step = session.current_step

        # ìŠ¤í‚µ ì²˜ë¦¬
        if 'ìŠ¤í‚µ' in message or 'skip' in message.lower():
            result = await self._handle_skip(session)
            self._save(session)
            return self._format_response(session, result)

        # ========== CHARACTER ë‹¨ê³„ì—ì„œ ì´ë¯¸ì§€ + í™•ì • ì²˜ë¦¬ ==========
        if current_step == WorkflowStep.CHARACTER and images and len(images) > 0:
            if self._is_confirmation(message):
                # 1. VL ëª¨ë¸ë¡œ ìºë¦­í„° ë¶„ì„
                img = images[0]
                if img.startswith('data:'):
                    img = img.split(',', 1)[1]

                char_intro = ''
                try:
                    char_info = await vision_service.describe_character(img)
                    char_intro = self._format_character_intro(char_info)
                except Exception as e:
                    print(f'[Orchestrator] Character analysis failed: {e}')
                    char_intro = ''

                # 2. ì´ë¯¸ì§€ ì €ì¥
                # ì´ë¯¸ì§€ ìµœì í™” (ìš©ëŸ‰ ê°ì†Œ)
                optimized_image = optimize_image(images[0])
                session.context['character_image'] = optimized_image
                self.character_agent.set_context('character_image', optimized_image)

                # 3. í™•ì¸ ë©”ì‹œì§€ ë°˜í™˜ (ì•„ì§ ë‹¤ìŒ ë‹¨ê³„ë¡œ ì•ˆ ë„˜ì–´ê°)
                session.context['character_confirmed'] = True
                self._save(session)

                # ìºë¦­í„° ì†Œê°œ ë©”ì‹œì§€ êµ¬ì„± (ì´ëª¨ì§€ ì—†ìŒ)
                intro_line = f'\n\n{char_intro}' if char_intro else ''
                result_message = f'ìºë¦­í„° ì´ë¯¸ì§€ë¥¼ ì €ì¥í–ˆìŠµë‹ˆë‹¤.{intro_line}\n\nì´ ìºë¦­í„°ë¡œ ì˜ìƒì„ ì œì‘í• ê²Œìš”.\në‹¤ìŒ ë‹¨ê³„ë¡œ ì§„í–‰í•˜ë ¤ë©´ ì•„ë¬´ ë©”ì‹œì§€ë‚˜ ì…ë ¥í•´ì£¼ì„¸ìš”.'

                return {
                    'session_id': session.id,
                    'current_step': 'character_confirmed',
                    'message': result_message,
                    'images': images,
                    'needs_feedback': True,
                    'data': {'character_image': optimized_image, 'pending_next_step': 'video_ideas'},
                    'success': True,
                    'context': session.context
                }

        # ========== CHARACTER í™•ì • í›„ VIDEO_IDEASë¡œ ìë™ ì§„í–‰ ==========
        if current_step == WorkflowStep.CHARACTER and session.context.get('character_confirmed'):
            session.context.pop('character_confirmed', None)
            session.current_step = WorkflowStep.VIDEO_IDEAS

            result = await self.planner.execute({
                'step': 'video_ideas',
                **session.context
            })

            if result.data and 'ideas' in result.data:
                session.context['video_ideas'] = result.data['ideas']

            self._save(session)
            return self._format_response(session, result)

        # ========== VIDEO_IDEAS ë‹¨ê³„ì—ì„œ ìƒˆ ì£¼ì œ ì…ë ¥ ì²˜ë¦¬ ==========
        if current_step == WorkflowStep.VIDEO_IDEAS:
            # ìˆ«ì ì„ íƒ
            num = self._extract_number(message)
            if num is not None:
                ideas = session.context.get('video_ideas', [])
                if 0 < num <= len(ideas):
                    session.context['selected_video_idea'] = ideas[num - 1]
                    self.planner.set_context('selected_video_idea', ideas[num - 1])

                    # SCRIPT ë‹¨ê³„ë¡œ ì´ë™
                    session.current_step = WorkflowStep.SCRIPT
                    result = await self.planner.execute({
                        'step': 'script',
                        **session.context
                    })

                    if result.data and 'script' in result.data:
                        session.context['script'] = result.data['script']

                    self._save(session)
                    return self._format_response(session, result)

            # í™•ì • (ì²«ë²ˆì§¸ ì•„ì´ë””ì–´ ì„ íƒ)
            if self._is_confirmation(message):
                ideas = session.context.get('video_ideas', [])
                if ideas:
                    session.context['selected_video_idea'] = ideas[0]
                    self.planner.set_context('selected_video_idea', ideas[0])

                    session.current_step = WorkflowStep.SCRIPT
                    result = await self.planner.execute({
                        'step': 'script',
                        **session.context
                    })

                    if result.data and 'script' in result.data:
                        session.context['script'] = result.data['script']

                    self._save(session)
                    return self._format_response(session, result)

            # ìƒˆë¡œìš´ ì£¼ì œ ì…ë ¥ (5ì ì´ìƒì´ê³  í™•ì • í‚¤ì›Œë“œê°€ ì•„ë‹Œ ê²½ìš°)
            if len(message) > 5 and not self._is_confirmation(message) and not self._is_selection(message):
                # ìƒˆ ì£¼ì œë¡œ ì•„ì´ë””ì–´ ì¬ìƒì„±
                result = await self.planner.execute({
                    'step': 'video_ideas',
                    'user_topic': message,
                    **session.context
                })

                if result.data and 'ideas' in result.data:
                    session.context['video_ideas'] = result.data['ideas']

                self._save(session)
                return self._format_response(session, result)

        # ========== ìˆ«ì ì„ íƒ ì²˜ë¦¬ (ë‹¤ë¥¸ ë‹¨ê³„) ==========
        if current_step != WorkflowStep.BENCHMARKING:
            num = self._extract_number(message)
            if num is not None:
                result = await self._handle_selection(session, num)
                self._save(session)
                return self._format_response(session, result)

        # ========== í™•ì • ì²˜ë¦¬ ==========
        if self._is_confirmation(message):
            result = await self._handle_next_step(session)
            self._save(session)
            return self._format_response(session, result)

        # ========== ê¸°ë³¸ í”¼ë“œë°± ì²˜ë¦¬ ==========
        agent = self._get_current_agent(current_step, session_id)
        result = await agent.handle_feedback(message, images)

        # ë²¤ì¹˜ë§ˆí‚¹ ì™„ë£Œ ì²˜ë¦¬
        if current_step == WorkflowStep.BENCHMARKING:
            if result.data:
                if result.data.get('skipped'):
                    session.current_step = WorkflowStep.CHARACTER
                    char_result = await self.character_agent.execute({
                        'step': 'character',
                        **session.context
                    })
                    self._save(session)
                    return self._format_response(session, char_result)

                if result.data.get('report') and not result.needs_feedback:
                    session.context['benchmark_report'] = result.data['report']
                    session.context['benchmark_shown'] = True
                    result.message = result.message + "\n\n---\n\n**ë¦¬í¬íŠ¸ í™•ì¸ ì™„ë£Œ!**\në‹¤ìŒ ë‹¨ê³„ë¡œ ì§„í–‰í•˜ë ¤ë©´ í™•ì¸ ë˜ëŠ” ë‹¤ìŒì„ ì…ë ¥í•˜ì„¸ìš”."
                    result.needs_feedback = True
                    self._save(session)
                    return self._format_response(session, result)

                if session.context.get('benchmark_shown'):
                    session.current_step = WorkflowStep.CHARACTER
                    char_result = await self.character_agent.execute({
                        'step': 'character',
                        **session.context
                    })
                    self._save(session)
                    return self._format_response(session, char_result)

        self._save(session)
        return self._format_response(session, result)

    async def _handle_selection(self, session: Session, num: int) -> AgentResult:
        current_step = session.current_step

        if current_step == WorkflowStep.CHANNEL_NAME:
            names = session.context.get('channel_names', [])
            if 0 < num <= len(names):
                session.context['selected_channel_name'] = names[num - 1]
                self.planner.set_context('selected_channel_name', names[num - 1])

        elif current_step == WorkflowStep.VIDEO_IDEAS:
            ideas = session.context.get('video_ideas', [])
            if 0 < num <= len(ideas):
                session.context['selected_video_idea'] = ideas[num - 1]
                self.planner.set_context('selected_video_idea', ideas[num - 1])

        return await self._handle_next_step(session)

    async def _handle_next_step(self, session: Session) -> AgentResult:
        current_step = session.current_step
        next_idx = self.STEP_ORDER.index(current_step) + 1

        if next_idx >= len(self.STEP_ORDER):
            return self._complete_result(session)

        session.current_step = self.STEP_ORDER[next_idx]

        if session.current_step == WorkflowStep.COMPLETED:
            return self._complete_result(session)

        agent = self._get_current_agent(session.current_step, session.id)
        result = await agent.execute({
            'step': session.current_step.value,
            **session.context
        })

        if result.data:
            if 'ideas' in result.data:
                session.context['video_ideas'] = result.data['ideas']
            if 'script' in result.data:
                session.context['script'] = result.data['script']
            if 'report' in result.data:
                session.context['benchmark_report'] = result.data['report']

        return result

    async def _handle_skip(self, session: Session) -> AgentResult:
        return await self._handle_next_step(session)

    def _complete_result(self, session: Session) -> AgentResult:
        channel = session.context.get('selected_channel_name', '')
        idea = session.context.get('selected_video_idea', {})
        idea_title = idea.get('title', '') if isinstance(idea, dict) else str(idea)
        has_benchmark = 'benchmark_report' in session.context

        msg = f'ğŸ‰ ëª¨ë“  ê¸°íš ë‹¨ê³„ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!\n\n**ì±„ë„ëª…**: {channel}\n**ì˜ìƒ ì£¼ì œ**: {idea_title}'
        if has_benchmark:
            msg += '\n**ë²¤ì¹˜ë§ˆí‚¹**: ì™„ë£Œ'

        return AgentResult(
            success=True,
            step='completed',
            message=msg,
            data=session.context
        )

    def _format_response(self, session: Session, result: AgentResult) -> Dict[str, Any]:
        return {
            'session_id': session.id,
            'current_step': session.current_step.value,
            'message': result.message,
            'images': result.images,
            'needs_feedback': result.needs_feedback,
            'data': result.data,
            'success': result.success,
            'context': session.context
        }

orchestrator = Orchestrator()
